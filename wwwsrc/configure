########################
#Thunder 2003.6.5
#auto generate Makefile in the subdir
########################
#!/bin/bash

SRC="init main board tools service admin digest wml"

BBSHOME="/home/bbs"
CGIPATH="/home/www/cgi-bin/bbs"
HTMLPATH="/home/www/html"
INCLUDEDIR="$PWD/include"


generatemkfile()
{





cd $1
echo  "-->"
echo  "   $PWD"
echo "#Makefile generated by configure" >Makefile
echo "#$(date)"  >>Makefile
echo >> Makefile
echo "BBSHOME = $BBSHOME"  >>Makefile
echo "CGIPATH = $CGIPATH" >>Makefile
echo "HTMPATH = $HTMLPATH">>Makefile
echo "INCLUDEDIR=$INCLUDEDIR">>Makefile
echo 'CC      = gcc -O3 -I$(INCLUDEDIR)' >>Makefile
printf "\n%s" "CGI     =" >>Makefile
        
          
        for x in $(ls *.c)
        do
           if [ -f $x ]
           then
                  printf " %s " ${x%%.c}  >>Makefile
            fi
       done


        for x in $(ls)
	do

	  if [ -d $x ]
	  then
                if [ $x != "CVS" ]
		then
          	generatemkfile  $x
                fi
          fi

        done
    
        printf "\n%s\n"   'all: $(CGI)' >>Makefile
	gcc  -MM -I$INCLUDEDIR  *.c   >>Makefile   2>/dev/null
        printf "\n%s\n%s\n"   "update: install"  "install: all"   >>Makefile
	printf "\t%s\n"  'cp $(CGI) $(CGIPATH)  '  >>Makefile
        printf "\n%s\n\t%s\n"  "clean:" 'rm -rf *.o; rm -rf $(CGI)' >>Makefile

        chmod 660 Makefile

         ls *.c >/dev/null
         if [ $? -ne 0 ]
                then
                rm Makefile
         fi


        
        echo  "   $PWD"
	echo  "<--"
	cd ..


}



      for a in $SRC
      do 
	 generatemkfile $a
      done

	
echo "done."
